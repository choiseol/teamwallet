// ========================================
// Google Apps Script - í†µí•© ë²„ì „
// ìŠ¤í”„ë ˆë“œì‹œíŠ¸ > í™•ì¥ í”„ë¡œê·¸ë¨ > Apps Scriptì— ë¶™ì—¬ë„£ê¸°
// ========================================

const SHEET_NAME = 'Sheet1'; // ì‹œíŠ¸ ì´ë¦„ (í•„ìš”ì‹œ ìˆ˜ì •)
const BUDGET_PER_PERSON = 50000;

function doGet(e) {
  return HtmlService.createHtmlOutput(getHtmlContent())
    .setTitle('TeamBudget - íŒ€ ì¡°ì§ê²½ë¹„ ê´€ë¦¬')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

function getData() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
  const data = sheet.getDataRange().getValues();
  if (data.length <= 1) return [];
  
  const headers = data[0];
  return data.slice(1).map((row, index) => {
    const obj = { rowIndex: index + 2 };
    headers.forEach((h, i) => obj[h] = row[i]);
    return obj;
  });
}

function addExpense(month, teamSize, name, amount, description) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
  sheet.appendRow([
    month,
    teamSize,
    name,
    amount,
    description,
    new Date().toLocaleDateString('ko-KR')
  ]);
  return { success: true };
}

function deleteExpense(rowIndex) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
  if (rowIndex > 1) {
    sheet.deleteRow(rowIndex);
  }
  return { success: true };
}

function updateTeamSize(month, teamSize) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
  const data = sheet.getDataRange().getValues();
  let found = false;
  
  for (let i = 1; i < data.length; i++) {
    if (data[i][0] === month) {
      sheet.getRange(i + 1, 2).setValue(teamSize);
      found = true;
    }
  }
  
  if (!found) {
    sheet.appendRow([month, teamSize, '', '', '', '']);
  }
  return { success: true };
}

function getHtmlContent() {
  return `<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TeamBudget</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8fafc; min-height: 100vh; padding: 16px; }
    .container { max-width: 600px; margin: 0 auto; }
    .card { background: white; border-radius: 16px; padding: 20px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #f1f5f9; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .title { font-size: 20px; font-weight: 700; color: #1e293b; }
    .month-input { font-size: 14px; border: 1px solid #e2e8f0; border-radius: 8px; padding: 4px 8px; color: #475569; }
    .team-row { display: flex; align-items: center; gap: 12px; padding: 12px; background: #f8fafc; border-radius: 12px; margin-bottom: 16px; flex-wrap: wrap; }
    .team-row span { font-size: 14px; color: #475569; }
    .team-input { width: 60px; text-align: center; border: 1px solid #e2e8f0; border-radius: 8px; padding: 4px 8px; font-weight: 500; }
    .sync-btn { background: #10b981; color: white; border: none; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 12px; margin-left: auto; }
    .sync-btn:hover { background: #059669; }
    .sync-btn:disabled { background: #94a3b8; cursor: not-allowed; }
    
    .balance-box { border-radius: 16px; padding: 20px; text-align: center; margin-bottom: 12px; }
    .balance-box.positive { background: #f0fdf4; border: 2px solid #bbf7d0; }
    .balance-box.negative { background: #fef2f2; border: 2px solid #fecaca; }
    .balance-label { font-size: 14px; margin-bottom: 4px; }
    .balance-label.positive { color: #16a34a; }
    .balance-label.negative { color: #dc2626; }
    .balance-amount { font-size: 28px; font-weight: 700; }
    .balance-amount.positive { color: #15803d; }
    .balance-amount.negative { color: #b91c1c; }
    
    .stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .stat-box { border-radius: 12px; padding: 16px; text-align: center; }
    .stat-box.budget { background: #eff6ff; }
    .stat-box.spent { background: #fff7ed; }
    .stat-icon { font-size: 20px; margin-bottom: 4px; }
    .stat-label { font-size: 12px; margin-bottom: 4px; }
    .stat-label.budget { color: #2563eb; }
    .stat-label.spent { color: #ea580c; }
    .stat-amount { font-weight: 700; }
    .stat-amount.budget { color: #1d4ed8; }
    .stat-amount.spent { color: #c2410c; }
    
    .progress-bar { height: 12px; background: #f1f5f9; border-radius: 999px; overflow: hidden; margin-top: 16px; }
    .progress-fill { height: 100%; transition: width 0.3s; }
    .progress-fill.safe { background: #3b82f6; }
    .progress-fill.warning { background: #fb923c; }
    .progress-fill.danger { background: #ef4444; }
    .progress-text { font-size: 12px; color: #94a3b8; text-align: right; margin-top: 4px; }
    
    .section-title { font-weight: 600; color: #334155; margin-bottom: 12px; }
    .input-row { display: flex; gap: 8px; margin-bottom: 8px; }
    .input-field { flex: 1; border: 1px solid #e2e8f0; border-radius: 8px; padding: 8px 12px; font-size: 14px; }
    .input-field.amount { width: 100px; flex: none; }
    .add-btn { background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; }
    .add-btn:hover { background: #2563eb; }
    .add-btn:disabled { background: #94a3b8; cursor: not-allowed; }
    
    .expense-list { max-height: 256px; overflow-y: auto; }
    .expense-item { display: flex; align-items: center; justify-content: space-between; padding: 12px; background: #f8fafc; border-radius: 12px; margin-bottom: 8px; }
    .expense-info { flex: 1; }
    .expense-name { font-weight: 500; color: #334155; }
    .expense-desc { font-size: 12px; color: #64748b; margin-top: 2px; }
    .expense-amount { font-weight: 600; color: #334155; margin-right: 12px; }
    .delete-btn { background: none; border: none; color: #94a3b8; cursor: pointer; font-size: 18px; }
    .delete-btn:hover { color: #ef4444; }
    
    .empty-state { text-align: center; color: #94a3b8; padding: 32px; }
    .footer { text-align: center; font-size: 12px; color: #94a3b8; }
    .status { text-align: center; font-size: 12px; padding: 8px; border-radius: 8px; margin-bottom: 16px; display: none; }
    .status.loading { background: #fef3c7; color: #92400e; display: block; }
    .status.error { background: #fee2e2; color: #991b1b; display: block; }
    .status.success { background: #d1fae5; color: #065f46; display: block; }
  </style>
</head>
<body>
  <div class="container">
    <div id="statusBar" class="status loading">ğŸ”„ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    
    <div class="card">
      <div class="header">
        <h1 class="title">TeamBudget</h1>
        <input type="month" id="monthInput" class="month-input" value="2026-01">
      </div>
      
      <div class="team-row">
        <span>ğŸ‘¥</span>
        <span>íŒ€ì› ìˆ˜</span>
        <input type="number" id="teamSize" class="team-input" value="7" min="1">
        <span>Ã— 5ë§Œì› = <strong id="totalBudgetText">350,000ì›</strong></span>
        <button id="syncBtn" class="sync-btn" onclick="loadData()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
      </div>
      
      <div id="balanceBox" class="balance-box positive">
        <p id="balanceLabel" class="balance-label positive">âœ“ ì”ì•¡</p>
        <p id="balanceAmount" class="balance-amount positive">350,000ì›</p>
      </div>
      
      <div class="stats-row">
        <div class="stat-box budget">
          <div class="stat-icon">ğŸ’°</div>
          <p class="stat-label budget">ì´ ì˜ˆì‚°</p>
          <p id="budgetAmount" class="stat-amount budget">350,000ì›</p>
        </div>
        <div class="stat-box spent">
          <div class="stat-icon">ğŸ“‰</div>
          <p class="stat-label spent">ì‚¬ìš©ì•¡</p>
          <p id="spentAmount" class="stat-amount spent">0ì›</p>
        </div>
      </div>
      
      <div class="progress-bar">
        <div id="progressFill" class="progress-fill safe" style="width: 0%"></div>
      </div>
      <p id="progressText" class="progress-text">0.0% ì‚¬ìš©</p>
    </div>
    
    <div class="card">
      <h2 class="section-title">ì§€ì¶œ ì…ë ¥</h2>
      <div class="input-row">
        <input type="text" id="inputName" class="input-field" placeholder="ì‚¬ìš©ì">
        <input type="number" id="inputAmount" class="input-field amount" placeholder="ê¸ˆì•¡">
      </div>
      <div class="input-row">
        <input type="text" id="inputDesc" class="input-field" placeholder="ì‚¬ìš© ë‚´ì—­ (ì„ íƒ)">
        <button id="addBtn" class="add-btn" onclick="addExpense()">â• ì¶”ê°€</button>
      </div>
    </div>
    
    <div class="card">
      <h2 class="section-title">ì§€ì¶œ ë‚´ì—­ <span id="expenseCount" style="font-weight:normal;color:#94a3b8">(0ê±´)</span></h2>
      <div id="expenseList" class="expense-list">
        <p class="empty-state">ì•„ì§ ì§€ì¶œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p>
      </div>
    </div>
    
    <p class="footer">ğŸ’¡ ì´ URLì„ íŒ€ì›ë“¤ê³¼ ê³µìœ í•˜ì„¸ìš”</p>
  </div>

  <script>
    const BUDGET_PER_PERSON = 50000;
    let teamSize = 7;
    let expenses = [];
    let allData = [];
    let currentMonth = '2026-01';

    function showStatus(msg, type) {
      const bar = document.getElementById('statusBar');
      bar.textContent = msg;
      bar.className = 'status ' + type;
      if (type === 'success') setTimeout(() => bar.style.display = 'none', 2000);
    }

    function loadData() {
      showStatus('ğŸ”„ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', 'loading');
      document.getElementById('syncBtn').disabled = true;
      
      google.script.run
        .withSuccessHandler(data => {
          allData = data;
          filterByMonth();
          showStatus('âœ… ë™ê¸°í™” ì™„ë£Œ', 'success');
          document.getElementById('syncBtn').disabled = false;
        })
        .withFailureHandler(err => {
          showStatus('âŒ ì˜¤ë¥˜: ' + err.message, 'error');
          document.getElementById('syncBtn').disabled = false;
        })
        .getData();
    }

    function filterByMonth() {
      const monthData = allData.filter(row => row.month === currentMonth);
      if (monthData.length > 0 && monthData[0].teamSize) {
        teamSize = parseInt(monthData[0].teamSize) || 7;
        document.getElementById('teamSize').value = teamSize;
      }
      expenses = monthData.filter(row => row.name && row.amount).map(row => ({
        rowIndex: row.rowIndex,
        name: row.name,
        amount: parseInt(row.amount) || 0,
        description: row.description || ''
      }));
      render();
    }

    function formatCurrency(n) { return n.toLocaleString('ko-KR') + 'ì›'; }

    function render() {
      const totalBudget = teamSize * BUDGET_PER_PERSON;
      const totalSpent = expenses.reduce((sum, e) => sum + e.amount, 0);
      const remaining = totalBudget - totalSpent;
      const pct = totalBudget > 0 ? (totalSpent / totalBudget) * 100 : 0;

      document.getElementById('totalBudgetText').textContent = formatCurrency(totalBudget);
      document.getElementById('budgetAmount').textContent = formatCurrency(totalBudget);
      document.getElementById('spentAmount').textContent = formatCurrency(totalSpent);

      const box = document.getElementById('balanceBox');
      const lbl = document.getElementById('balanceLabel');
      const amt = document.getElementById('balanceAmount');

      if (remaining >= 0) {
        box.className = 'balance-box positive';
        lbl.className = 'balance-label positive';
        lbl.textContent = 'âœ“ ì”ì•¡';
        amt.className = 'balance-amount positive';
        amt.textContent = formatCurrency(remaining);
      } else {
        box.className = 'balance-box negative';
        lbl.className = 'balance-label negative';
        lbl.textContent = 'âš ï¸ ì˜ˆì‚° ì´ˆê³¼';
        amt.className = 'balance-amount negative';
        amt.textContent = formatCurrency(Math.abs(remaining)) + ' ì´ˆê³¼';
      }

      const fill = document.getElementById('progressFill');
      fill.style.width = Math.min(pct, 100) + '%';
      fill.className = 'progress-fill ' + (pct > 100 ? 'danger' : pct > 80 ? 'warning' : 'safe');
      document.getElementById('progressText').textContent = pct.toFixed(1) + '% ì‚¬ìš©';
      document.getElementById('expenseCount').textContent = '(' + expenses.length + 'ê±´)';

      const list = document.getElementById('expenseList');
      if (expenses.length === 0) {
        list.innerHTML = '<p class="empty-state">ì•„ì§ ì§€ì¶œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p>';
      } else {
        list.innerHTML = expenses.map(e => 
          '<div class="expense-item">' +
            '<div class="expense-info">' +
              '<span class="expense-name">' + e.name + '</span>' +
              (e.description ? '<p class="expense-desc">' + e.description + '</p>' : '') +
            '</div>' +
            '<span class="expense-amount">' + formatCurrency(e.amount) + '</span>' +
            '<button class="delete-btn" onclick="deleteExpense(' + e.rowIndex + ')">ğŸ—‘ï¸</button>' +
          '</div>'
        ).join('');
      }
    }

    function addExpense() {
      const name = document.getElementById('inputName').value.trim();
      const amount = parseInt(document.getElementById('inputAmount').value);
      const desc = document.getElementById('inputDesc').value.trim();
      if (!name || !amount) { alert('ì‚¬ìš©ìì™€ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

      document.getElementById('addBtn').disabled = true;
      showStatus('ğŸ’¾ ì €ì¥ ì¤‘...', 'loading');

      google.script.run
        .withSuccessHandler(() => {
          document.getElementById('inputName').value = '';
          document.getElementById('inputAmount').value = '';
          document.getElementById('inputDesc').value = '';
          document.getElementById('addBtn').disabled = false;
          loadData();
        })
        .withFailureHandler(err => {
          showStatus('âŒ ì €ì¥ ì‹¤íŒ¨: ' + err.message, 'error');
          document.getElementById('addBtn').disabled = false;
        })
        .addExpense(currentMonth, teamSize, name, amount, desc);
    }

    function deleteExpense(rowIndex) {
      if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      showStatus('ğŸ—‘ï¸ ì‚­ì œ ì¤‘...', 'loading');
      google.script.run
        .withSuccessHandler(() => loadData())
        .withFailureHandler(err => showStatus('âŒ ì‚­ì œ ì‹¤íŒ¨: ' + err.message, 'error'))
        .deleteExpense(rowIndex);
    }

    document.getElementById('teamSize').addEventListener('change', e => {
      teamSize = Math.max(1, parseInt(e.target.value) || 1);
      render();
      google.script.run.updateTeamSize(currentMonth, teamSize);
    });

    document.getElementById('monthInput').addEventListener('change', e => {
      currentMonth = e.target.value;
      filterByMonth();
    });

    document.getElementById('inputDesc').addEventListener('keydown', e => {
      if (e.key === 'Enter') addExpense();
    });

    loadData();
  </script>
</body>
</html>`;
}
