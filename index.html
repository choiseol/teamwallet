<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TeamBudget - íŒ€ ì¡°ì§ê²½ë¹„ ê´€ë¦¬</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8fafc; min-height: 100vh; padding: 16px; }
    .container { max-width: 600px; margin: 0 auto; }
    .card { background: white; border-radius: 16px; padding: 20px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #f1f5f9; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .title { font-size: 20px; font-weight: 700; color: #1e293b; }
    .month-input { font-size: 14px; border: 1px solid #e2e8f0; border-radius: 8px; padding: 4px 8px; color: #475569; }
    .team-row { display: flex; align-items: center; gap: 12px; padding: 12px; background: #f8fafc; border-radius: 12px; margin-bottom: 16px; flex-wrap: wrap; }
    .team-row span { font-size: 14px; color: #475569; }
    .team-input { width: 60px; text-align: center; border: 1px solid #e2e8f0; border-radius: 8px; padding: 4px 8px; font-weight: 500; }
    .sync-btn { background: #10b981; color: white; border: none; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 12px; margin-left: auto; }
    .sync-btn:hover { background: #059669; }
    .sync-btn:disabled { background: #94a3b8; cursor: not-allowed; }
    
    .balance-box { border-radius: 16px; padding: 20px; text-align: center; margin-bottom: 12px; }
    .balance-box.positive { background: #f0fdf4; border: 2px solid #bbf7d0; }
    .balance-box.negative { background: #fef2f2; border: 2px solid #fecaca; }
    .balance-label { font-size: 14px; margin-bottom: 4px; }
    .balance-label.positive { color: #16a34a; }
    .balance-label.negative { color: #dc2626; }
    .balance-amount { font-size: 28px; font-weight: 700; }
    .balance-amount.positive { color: #15803d; }
    .balance-amount.negative { color: #b91c1c; }
    
    .stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .stat-box { border-radius: 12px; padding: 16px; text-align: center; }
    .stat-box.budget { background: #eff6ff; }
    .stat-box.spent { background: #fff7ed; }
    .stat-icon { font-size: 20px; margin-bottom: 4px; }
    .stat-label { font-size: 12px; margin-bottom: 4px; }
    .stat-label.budget { color: #2563eb; }
    .stat-label.spent { color: #ea580c; }
    .stat-amount { font-weight: 700; }
    .stat-amount.budget { color: #1d4ed8; }
    .stat-amount.spent { color: #c2410c; }
    
    .progress-bar { height: 12px; background: #f1f5f9; border-radius: 999px; overflow: hidden; margin-top: 16px; }
    .progress-fill { height: 100%; transition: width 0.3s; }
    .progress-fill.safe { background: #3b82f6; }
    .progress-fill.warning { background: #fb923c; }
    .progress-fill.danger { background: #ef4444; }
    .progress-text { font-size: 12px; color: #94a3b8; text-align: right; margin-top: 4px; }
    
    .section-title { font-weight: 600; color: #334155; margin-bottom: 12px; }
    .input-row { display: flex; gap: 8px; margin-bottom: 8px; }
    .input-field { flex: 1; border: 1px solid #e2e8f0; border-radius: 8px; padding: 8px 12px; font-size: 14px; }
    .input-field.amount { width: 100px; flex: none; }
    .add-btn { background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 4px; }
    .add-btn:hover { background: #2563eb; }
    .add-btn:disabled { background: #94a3b8; cursor: not-allowed; }
    
    .expense-list { max-height: 256px; overflow-y: auto; }
    .expense-item { display: flex; align-items: center; justify-content: space-between; padding: 12px; background: #f8fafc; border-radius: 12px; margin-bottom: 8px; }
    .expense-info { flex: 1; }
    .expense-name { font-weight: 500; color: #334155; }
    .expense-date { font-size: 12px; color: #94a3b8; margin-left: 8px; }
    .expense-desc { font-size: 12px; color: #64748b; margin-top: 2px; }
    .expense-amount { font-weight: 600; color: #334155; margin-right: 12px; }
    .delete-btn { background: none; border: none; color: #94a3b8; cursor: pointer; font-size: 18px; }
    .delete-btn:hover { color: #ef4444; }
    
    .empty-state { text-align: center; color: #94a3b8; padding: 32px; }
    .footer { text-align: center; font-size: 12px; color: #94a3b8; }
    .status { text-align: center; font-size: 12px; padding: 8px; border-radius: 8px; margin-bottom: 16px; }
    .status.loading { background: #fef3c7; color: #92400e; }
    .status.error { background: #fee2e2; color: #991b1b; }
    .status.success { background: #d1fae5; color: #065f46; }
    .setup-box { background: #fef3c7; border: 1px solid #fcd34d; border-radius: 12px; padding: 16px; margin-bottom: 16px; }
    .setup-box h3 { color: #92400e; margin-bottom: 8px; font-size: 14px; }
    .setup-box input { width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 12px; }
    .setup-box button { margin-top: 8px; background: #f59e0b; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; width: 100%; }
  </style>
</head>
<body>
  <div class="container">
    <div id="setupBox" class="setup-box">
      <h3>âš™ï¸ ì´ˆê¸° ì„¤ì • (ìµœì´ˆ 1íšŒ)</h3>
      <p style="font-size:12px;color:#78716c;margin-bottom:8px;">Google Apps Script ì›¹ì•± URLì„ ì…ë ¥í•˜ì„¸ìš”</p>
      <input type="text" id="scriptUrl" placeholder="https://script.google.com/macros/s/xxx/exec">
      <button onclick="saveScriptUrl()">ì €ì¥ í›„ ì‹œì‘</button>
    </div>

    <div id="mainApp" style="display:none;">
      <div id="statusBar" class="status loading">ğŸ”„ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      
      <div class="card">
        <div class="header">
          <h1 class="title">TeamBudget</h1>
          <input type="month" id="monthInput" class="month-input" value="2026-01">
        </div>
        
        <div class="team-row">
          <span>ğŸ‘¥</span>
          <span>íŒ€ì› ìˆ˜</span>
          <input type="number" id="teamSize" class="team-input" value="7" min="1">
          <span>Ã— 5ë§Œì› = <strong id="totalBudgetText">350,000ì›</strong></span>
          <button id="syncBtn" class="sync-btn" onclick="loadData()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
        </div>
        
        <div id="balanceBox" class="balance-box positive">
          <p id="balanceLabel" class="balance-label positive">âœ“ ì”ì•¡</p>
          <p id="balanceAmount" class="balance-amount positive">350,000ì›</p>
        </div>
        
        <div class="stats-row">
          <div class="stat-box budget">
            <div class="stat-icon">ğŸ’°</div>
            <p class="stat-label budget">ì´ ì˜ˆì‚°</p>
            <p id="budgetAmount" class="stat-amount budget">350,000ì›</p>
          </div>
          <div class="stat-box spent">
            <div class="stat-icon">ğŸ“‰</div>
            <p class="stat-label spent">ì‚¬ìš©ì•¡</p>
            <p id="spentAmount" class="stat-amount spent">0ì›</p>
          </div>
        </div>
        
        <div class="progress-bar">
          <div id="progressFill" class="progress-fill safe" style="width: 0%"></div>
        </div>
        <p id="progressText" class="progress-text">0.0% ì‚¬ìš©</p>
      </div>
      
      <div class="card">
        <h2 class="section-title">ì§€ì¶œ ì…ë ¥</h2>
        <div class="input-row">
          <input type="text" id="inputName" class="input-field" placeholder="ì‚¬ìš©ì">
          <input type="number" id="inputAmount" class="input-field amount" placeholder="ê¸ˆì•¡">
        </div>
        <div class="input-row">
          <input type="text" id="inputDesc" class="input-field" placeholder="ì‚¬ìš© ë‚´ì—­ (ì„ íƒ)">
          <button id="addBtn" class="add-btn" onclick="addExpense()">â• ì¶”ê°€</button>
        </div>
      </div>
      
      <div class="card">
        <h2 class="section-title">ì§€ì¶œ ë‚´ì—­ <span id="expenseCount" style="font-weight:normal;color:#94a3b8">(0ê±´)</span></h2>
        <div id="expenseList" class="expense-list">
          <p class="empty-state">ì•„ì§ ì§€ì¶œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p>
        </div>
      </div>
      
      <p class="footer">ğŸ’¡ íŒ€ì›ë“¤ê³¼ ê°™ì€ URLì„ ê³µìœ í•˜ë©´ ë°ì´í„°ê°€ ì‹¤ì‹œê°„ ë™ê¸°í™”ë©ë‹ˆë‹¤</p>
    </div>
  </div>

  <script>
    const BUDGET_PER_PERSON = 50000;
    let SCRIPT_URL = '';
    let teamSize = 7;
    let expenses = [];
    let allData = [];
    let currentMonth = '2026-01';

    function init() {
      const savedUrl = localStorage.getItem('teambudget-script-url');
      if (savedUrl) {
        SCRIPT_URL = savedUrl;
        document.getElementById('setupBox').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        loadData();
      }
    }

    function saveScriptUrl() {
      const url = document.getElementById('scriptUrl').value.trim();
      if (!url.startsWith('https://script.google.com/')) {
        alert('ì˜¬ë°”ë¥¸ Google Apps Script URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      SCRIPT_URL = url;
      localStorage.setItem('teambudget-script-url', url);
      document.getElementById('setupBox').style.display = 'none';
      document.getElementById('mainApp').style.display = 'block';
      loadData();
    }

    function showStatus(message, type) {
      const bar = document.getElementById('statusBar');
      bar.textContent = message;
      bar.className = 'status ' + type;
      if (type === 'success') {
        setTimeout(() => { bar.style.display = 'none'; }, 2000);
      } else {
        bar.style.display = 'block';
      }
    }

    async function loadData() {
      showStatus('ğŸ”„ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', 'loading');
      document.getElementById('syncBtn').disabled = true;
      
      try {
        const res = await fetch(SCRIPT_URL);
        const json = await res.json();
        
        if (json.success) {
          allData = json.data;
          filterByMonth();
          showStatus('âœ… ë™ê¸°í™” ì™„ë£Œ', 'success');
        } else {
          showStatus('âŒ ì˜¤ë¥˜: ' + json.message, 'error');
        }
      } catch (e) {
        showStatus('âŒ ì—°ê²° ì‹¤íŒ¨: ' + e.message, 'error');
      }
      
      document.getElementById('syncBtn').disabled = false;
    }

    function filterByMonth() {
      const monthData = allData.filter(row => row.month === currentMonth);
      
      if (monthData.length > 0 && monthData[0].teamSize) {
        teamSize = parseInt(monthData[0].teamSize) || 7;
        document.getElementById('teamSize').value = teamSize;
      }
      
      expenses = monthData
        .filter(row => row.name && row.amount)
        .map((row, i) => ({
          rowIndex: allData.indexOf(row) + 2,
          name: row.name,
          amount: parseInt(row.amount) || 0,
          description: row.description || ''
        }));
      
      render();
    }

    function formatCurrency(n) {
      return n.toLocaleString('ko-KR') + 'ì›';
    }

    function render() {
      const totalBudget = teamSize * BUDGET_PER_PERSON;
      const totalSpent = expenses.reduce((sum, e) => sum + e.amount, 0);
      const remaining = totalBudget - totalSpent;
      const usagePercent = totalBudget > 0 ? (totalSpent / totalBudget) * 100 : 0;

      document.getElementById('totalBudgetText').textContent = formatCurrency(totalBudget);
      document.getElementById('budgetAmount').textContent = formatCurrency(totalBudget);
      document.getElementById('spentAmount').textContent = formatCurrency(totalSpent);

      const balanceBox = document.getElementById('balanceBox');
      const balanceLabel = document.getElementById('balanceLabel');
      const balanceAmount = document.getElementById('balanceAmount');

      if (remaining >= 0) {
        balanceBox.className = 'balance-box positive';
        balanceLabel.className = 'balance-label positive';
        balanceLabel.textContent = 'âœ“ ì”ì•¡';
        balanceAmount.className = 'balance-amount positive';
        balanceAmount.textContent = formatCurrency(remaining);
      } else {
        balanceBox.className = 'balance-box negative';
        balanceLabel.className = 'balance-label negative';
        balanceLabel.textContent = 'âš ï¸ ì˜ˆì‚° ì´ˆê³¼';
        balanceAmount.className = 'balance-amount negative';
        balanceAmount.textContent = formatCurrency(Math.abs(remaining)) + ' ì´ˆê³¼';
      }

      const progressFill = document.getElementById('progressFill');
      progressFill.style.width = Math.min(usagePercent, 100) + '%';
      progressFill.className = 'progress-fill ' + (usagePercent > 100 ? 'danger' : usagePercent > 80 ? 'warning' : 'safe');
      document.getElementById('progressText').textContent = usagePercent.toFixed(1) + '% ì‚¬ìš©';

      document.getElementById('expenseCount').textContent = `(${expenses.length}ê±´)`;

      const listEl = document.getElementById('expenseList');
      if (expenses.length === 0) {
        listEl.innerHTML = '<p class="empty-state">ì•„ì§ ì§€ì¶œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p>';
      } else {
        listEl.innerHTML = expenses.map((e) => `
          <div class="expense-item">
            <div class="expense-info">
              <span class="expense-name">${e.name}</span>
              ${e.description ? `<p class="expense-desc">${e.description}</p>` : ''}
            </div>
            <span class="expense-amount">${formatCurrency(e.amount)}</span>
            <button class="delete-btn" onclick="deleteExpense(${e.rowIndex})">ğŸ—‘ï¸</button>
          </div>
        `).join('');
      }
    }

    async function addExpense() {
      const name = document.getElementById('inputName').value.trim();
      const amount = parseInt(document.getElementById('inputAmount').value);
      const description = document.getElementById('inputDesc').value.trim();

      if (!name || !amount) {
        alert('ì‚¬ìš©ìì™€ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      document.getElementById('addBtn').disabled = true;
      showStatus('ğŸ’¾ ì €ì¥ ì¤‘...', 'loading');

      try {
        await fetch(SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'add',
            month: currentMonth,
            teamSize: teamSize,
            name: name,
            amount: amount,
            description: description
          })
        });

        document.getElementById('inputName').value = '';
        document.getElementById('inputAmount').value = '';
        document.getElementById('inputDesc').value = '';
        
        setTimeout(() => loadData(), 1000);
        
      } catch (e) {
        showStatus('âŒ ì €ì¥ ì‹¤íŒ¨: ' + e.message, 'error');
      }

      document.getElementById('addBtn').disabled = false;
    }

    async function deleteExpense(rowIndex) {
      if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      
      showStatus('ğŸ—‘ï¸ ì‚­ì œ ì¤‘...', 'loading');

      try {
        await fetch(SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'delete',
            rowIndex: rowIndex
          })
        });
        
        setTimeout(() => loadData(), 1000);
        
      } catch (e) {
        showStatus('âŒ ì‚­ì œ ì‹¤íŒ¨: ' + e.message, 'error');
      }
    }

    document.getElementById('teamSize').addEventListener('change', async (e) => {
      teamSize = Math.max(1, parseInt(e.target.value) || 1);
      render();
      
      await fetch(SCRIPT_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'updateTeamSize',
          month: currentMonth,
          teamSize: teamSize
        })
      });
    });

    document.getElementById('monthInput').addEventListener('change', (e) => {
      currentMonth = e.target.value;
      filterByMonth();
    });

    document.getElementById('inputDesc').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') addExpense();
    });

    init();
  </script>
</body>
</html>
